---
import Button from '@components/Button.astro';

interface Props {
  placeholder?: string;
  buttonText?: string;
}

const {
  placeholder = "your@example.com",
  buttonText = "Subscribe"
} = Astro.props;
---

<form class="newsletter-form" novalidate aria-label="Subscription form">
  <div class="input-group">

    <input type="email" name="email" placeholder={placeholder} autocomplete="email" required />

    <Button type="submit" variant="tonal" action="default" size="medium" class="submit-btn">
      <span slot="iconLeft" class="state-icon-wrapper">
        <svg class="icon spin icon-loading" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        <svg class="icon icon-success" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </span>

      <span slot="text" class="state-text-wrapper">
        <span class="text-idle">{buttonText}</span>
        <span class="text-loading">Procesando</span>
        <span class="text-success">Suscrito</span>
      </span>
    </Button>
  </div>

  <div class="message-area" aria-live="polite">
    <span class="msg error"></span>
    <span class="msg success"></span>
  </div>
</form>

<script is:inline>
  // Lógica del cliente
  const forms = document.querySelectorAll('form.newsletter-form');

  forms.forEach((form) => {
    const formEl = form as HTMLFormElement;
    const input = formEl.querySelector('input') as HTMLInputElement;
    const submitBtn = formEl.querySelector('button') as HTMLButtonElement;
    const msgError = formEl.querySelector('.msg.error') as HTMLElement;
    const msgSuccess = formEl.querySelector('.msg.success') as HTMLElement;
    
    const setStatus = (status: 'idle' | 'loading' | 'success' | 'error', message = "") => {
      formEl.setAttribute('data-status', status);
      
      const isLoading = status === 'loading' || status === 'success';
      input.disabled = isLoading;
      submitBtn.disabled = isLoading;
      
      // Accesibilidad para el botón
      submitBtn.setAttribute('aria-disabled', isLoading ? 'true' : 'false');

      if (status === 'error') {
        msgError.textContent = message;
        msgError.style.display = 'block';
        msgSuccess.style.display = 'none';
        input.focus();
      } else if (status === 'success') {
        msgSuccess.textContent = message;
        msgSuccess.style.display = 'block';
        msgError.style.display = 'none';
        input.value = "";
      } else {
        msgError.style.display = 'none';
        msgSuccess.style.display = 'none';
      }
    };

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = input.value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!email || !emailRegex.test(email)) {
        setStatus('error', "Por favor ingresa un correo válido.");
        return;
      }

      setStatus('loading');

      try {
        const formData = new FormData();
        formData.append('email', email);

        // Llamada a la API de Astro
        const response = await fetch('/api/subscribe', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (!response.ok) throw new Error(result.message || "Error al suscribirse");
        
        setStatus('success', result.message || "¡Gracias! Revisa tu bandeja de entrada.");

        // Resetear a estado idle después de 4 segundos
        setTimeout(() => {
          setStatus('idle');
        }, 4000);

      } catch (err: any) {
        console.error(err);
        setStatus('error', err.message || "Algo salió mal. Intenta de nuevo.");
      }
    });
  });
</script>

<style is:global>
  .newsletter-form {
    max-width: 480px
  }

  .input-group {
    display: flex;
    gap: 8px;
    position: relative;
  }

  @media (max-width: 480px) {
    .input-group {
      flex-direction: column;
    }
    .submit-btn {
      width: 100%
    }
  }

  input {
    min-height: 44px;
    padding: 10px 14px 10px 42px;
    border: 1px solid var(--fill-border);
    border-radius: 32px;
    font-family: inherit;
    font-size: 15px;
    outline: none;
    background-color: var(--fill-background-secondary);
    color: var(--color-label-primary);
    transition: all 200ms ease-in-out
  }

  input:focus {
    border-color: var(--ring);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1)
  }
  
  /* Estado de error en el input */
  .newsletter-form[data-status="error"] input {
    border-color: var(--color-danger);
    background-color: var(--color-fill-danger-secondary)
  }

  input:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    background-color: #f9fafb
  }

  /* --- Gestión de Estados del Botón --- */
  /* Por defecto (idle) */
  .icon-loading, .icon-success, .text-loading, .text-success {
    display: none;
  }
  
  /* Cuando está cargando */
  .newsletter-form[data-status="loading"] .text-idle { display: none; }
  .newsletter-form[data-status="loading"] .icon-success { display: none; }
  
  .newsletter-form[data-status="loading"] .icon-loading { display: block; }
  .newsletter-form[data-status="loading"] .text-loading { display: block; }

  /* Cuando es exitoso */
  .newsletter-form[data-status="success"] .text-idle { display: none; }
  .newsletter-form[data-status="success"] .icon-loading { display: none; }
  
  .newsletter-form[data-status="success"] .icon-success { display: block; }
  .newsletter-form[data-status="success"] .text-success { display: block; }


  /* Animación del spinner */
  .spin {
    animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* --- Mensajes --- */
  .message-area {
    min-height: 24px;
    margin-top: 8px;
    padding-left: 14px; /* Alinear visualmente con el texto del input */
    font-size: 14px;
  }

  .msg {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .msg.error { color: var(--color-danger, #ef4444) }
  .msg.success { color: var(--color-success, #16a34a) }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px) }
    to { opacity: 1; transform: translateY(0) }
  }
</style>